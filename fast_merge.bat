@echo off
:: --- Инструкция по выбору кодировки для корректного отображения кириллицы ---
:: Если вы видите "кракозябры" вместо русских букв, проблема в кодировке.
::
:: Вариант 1 (Рекомендуемый и самый стабильный):
:: 1. Убедитесь, что в строке ниже используется команда: chcp 1251 > nul
:: 2. Сохраните этот .bat файл в кодировке "ANSI" или "Windows-1251".
::    (В Notepad++ это меню "Кодировки" -> "Преобразовать в ANSI").
::
:: Вариант 2 (Для современных систем, может быть нестабилен):
:: 1. Замените команду ниже на: chcp 65001 > nul
:: 2. Сохраните этот .bat файл в кодировке "UTF-8 with BOM" (UTF-8 с меткой).
chcp 65001 > nul
::
:: --- Описание ---
:: Этот скрипт использует ffmpeg для быстрого объединения нескольких видеофайлов в один.
:: Он склеивает видео без перекодирования, что происходит очень быстро.
::
:: Использование:
::   Просто выделите нужные видеофайлы в Проводнике и перетащите их на этот .bat файл.
::   Файлы будут склеены в том порядке, в котором их передаст операционная система.
::   Результат будет сохранен в файл "merged_output.mp4" в той же папке, где лежит скрипт.

setlocal enabledelayedexpansion

:: --- Поиск ffmpeg.exe ---
:: %~dp0 - это путь к папке, где находится сам .bat файл
if exist "%~dp0bin\ffmpeg.exe" (
    set "FFMPEG=%~dp0bin\ffmpeg.exe"
) else if exist "%~dp0ffmpeg.exe" (
    set "FFMPEG=%~dp0ffmpeg.exe"
) else (
    set "FFMPEG=ffmpeg.exe"
)

:: Создаем временный файл для списка видео
set "LIST_FILE=%TEMP%\gopro_merge_list_%RANDOM%.txt"
if exist "%LIST_FILE%" del "%LIST_FILE%"

:: Перебираем все переданные файлы (аргументы)
set "FILE_COUNT=0"
for %%f in (%*) do (
    echo file '%%~f'>> "%LIST_FILE%"
    set /a FILE_COUNT+=1
)

:: Проверяем, были ли переданы файлы
if %FILE_COUNT% equ 0 (
    echo Ошибка: Файлы для склейки не были переданы.
    echo Просто перетащите видеофайлы на этот скрипт.
    goto :cleanup
)

echo Начинаю склейку...
:: Используем -f concat для склейки из файла списка. Это самый надежный метод.
:: Добавляем -map 0:v -map 0:a, чтобы склеивать только видео и аудио, игнорируя проблемные потоки метаданных.
%FFMPEG% -f concat -safe 0 -i "%LIST_FILE%" -c copy -map 0:v -map 0:a "merged_output.mp4"

echo.
echo Склейка завершена! Результат сохранен в файл "merged_output.mp4"

:cleanup
:: Удаляем временный файл
if exist "%LIST_FILE%" del "%LIST_FILE%"
pause
